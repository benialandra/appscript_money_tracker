<!DOCTYPE html>
<html class="light" lang="id">

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DompetKu Pro / MyWallet Pro</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

  <script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
          fontFamily: { 
              sans: ['Montserrat', 'sans-serif'],
              arabic: ['Cairo', 'sans-serif']
          },
          extend: {
            colors: { primary: '#6366f1', darkbg: '#0f172a', darkcard: '#1e293b' }
          }
        }
      }
  </script>

  <style>
    html, body { margin: 0 !important; padding: 0 !important; width: 100%; height: 100%; overflow-x: hidden; transition: background-color 0.3s ease, color 0.3s ease; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    
    .fade-up { animation: fadeUp 0.5s ease-out forwards; opacity: 0; transform: translateY(15px); }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
    
    .bounce-card { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .bounce-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04); }
    .bounce-hover:hover { transform: scale(1.03) translateY(-5px); }
    
    .loader { width: 48px; height: 48px; border: 5px solid #e2e8f0; border-bottom-color: #6366f1; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
    .dark .loader { border-color: #334155; border-bottom-color: #818cf8; }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .dark option { background-color: #1e293b; color: white; }
    .dark .swal2-popup { background: #1e293b; color: #fff; }
    .dark .swal2-title { color: #fff; }
    button:disabled { cursor: not-allowed; opacity: 0.6; }
    body.hide-values .nominal-card-value { filter: blur(6px); opacity: 0.7; pointer-events: none; user-select: none; transition: all 0.3s ease; }
    .nominal-card-value { transition: all 0.3s ease; }

    /* =========================================
       CSS KHUSUS UNTUK SIDEBAR LTR & RTL (ANTI BUG)
       ========================================= */
    html[dir="rtl"] body { font-family: 'Cairo', sans-serif; }
    
    #sidebar, #main-content { 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    }

    /* 1. Kondisi Mobile (Disembunyikan di luar layar) */
    #sidebar { transform: translateX(-100%); }
    html[dir="rtl"] #sidebar { transform: translateX(100%); }

    /* 2. Kondisi Mobile (Dibuka via tombol menu) */
    body.mobile-sidebar-open #sidebar { transform: translateX(0); }
    html[dir="rtl"] body.mobile-sidebar-open #sidebar { transform: translateX(0); }

    /* 3. Kondisi Layar Besar (Desktop / Laptop) */
    @media (min-width: 768px) {
        #sidebar { transform: translateX(0); }
        html[dir="rtl"] #sidebar { transform: translateX(0); }
        
        #main-content { margin-inline-start: 16rem; /* w-64 = 16rem */ }
        
        /* 4. Kondisi Desktop (Sidebar Diperkecil) */
        body.sidebar-collapsed #sidebar { width: 5rem; }
        body.sidebar-collapsed #main-content { margin-inline-start: 5rem !important; }
        body.sidebar-collapsed .nav-text, body.sidebar-collapsed .logo-text { opacity: 0; display: none; }
        body.sidebar-collapsed .sidebar-header { justify-content: center; padding: 0; }
        body.sidebar-collapsed .nav-btn { justify-content: center; padding-left: 0; padding-right: 0; }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 dark:bg-darkbg dark:text-slate-100 font-sans h-screen flex overflow-hidden">

  <div id="global-loader" class="fixed inset-0 z-[200] bg-white/80 dark:bg-darkbg/90 backdrop-blur-sm flex flex-col items-center justify-center hidden transition-opacity duration-300">
    <span class="loader"></span>
    <p class="mt-4 font-bold text-slate-600 dark:text-slate-300 animate-pulse text-sm tracking-widest" id="loader-text" data-i18n="loading">Memuat...</p>
  </div>

  <div id="section-login" class="fixed inset-0 z-[100] bg-slate-100 dark:bg-darkbg flex items-center justify-center p-4">
    <div class="flex flex-col md:flex-row bg-white dark:bg-darkcard rounded-3xl shadow-2xl w-full max-w-4xl overflow-hidden border border-slate-100 dark:border-slate-700 fade-up relative">
      <div class="md:w-1/2 h-64 md:h-auto relative bg-blue-50 dark:bg-blue-900/20">
        <img src="https://lh3.googleusercontent.com/d/1F-8cLc2pGAxMjKeHLmRMJ2q7mn2nNmd6" class="w-full h-full object-cover object-center opacity-95">
        <div class="absolute inset-0 bg-gradient-to-t from-blue-900/70 to-transparent mix-blend-multiply"></div>
        <div class="absolute bottom-6 start-6 text-white p-4 hidden md:block">
          <p class="text-xl font-bold" data-i18n="login_hero_title">Raih Puncak Finansial!</p>
          <p class="text-sm opacity-90 mt-1" data-i18n="login_hero_desc">Kelola uangmu dengan cerdas, dan lihatlah grafiknya terus menanjak.</p>
        </div>
      </div>
      
      <div class="md:w-1/2 p-8 md:p-12 flex flex-col justify-center relative">
        <div class="absolute top-4 end-6" id="login-settings-container">
            <button onclick="toggleLoginSettings()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors shadow-sm" title="Pengaturan">
                <i class="fa-solid fa-gear"></i>
            </button>
            <div id="login-settings-dropdown" class="hidden absolute end-0 mt-2 w-48 bg-white dark:bg-darkcard rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 z-50 overflow-hidden transform transition-all">
                <div class="py-2 flex flex-col">
                    <button onclick="toggleLang(); toggleLoginSettings()" class="flex items-center justify-between w-full px-4 py-3 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <div class="flex items-center gap-3"><i class="fa-solid fa-earth-americas w-4 text-center"></i> <span data-i18n="language">Bahasa</span></div>
                        <span id="lang-indicator-login" class="flex items-center gap-1 text-[10px] font-bold bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 px-2 py-1 rounded-lg shadow-sm"><span class="fi fi-id rounded-sm"></span> ID</span>
                    </button>
                    <button onclick="toggleTheme()" class="flex items-center justify-between w-full px-4 py-3 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors border-t dark:border-slate-700">
                        <div class="flex items-center gap-3"><i class="fa-solid fa-palette w-4 text-center"></i> <span data-i18n="theme">Tema</span></div>
                        <div class="relative w-9 h-5 flex items-center bg-slate-200 dark:bg-slate-700 rounded-full p-1 transition-colors duration-300 focus:outline-none shadow-inner shrink-0">
                            <div class="w-3 h-3 bg-white dark:bg-indigo-400 rounded-full shadow transform transition-transform duration-300 dark:translate-x-0 ltr:translate-x-4 rtl:-translate-x-4"></div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <div class="text-center mb-8 mt-4">
          <div class="w-16 h-16 bg-primary rounded-2xl flex items-center justify-center mx-auto mb-4 text-white text-3xl shadow-lg shadow-indigo-500/30"><i class="fa-solid fa-wallet"></i></div>
          <h1 class="text-2xl font-bold text-slate-800 dark:text-white" data-i18n="login_welcome">Selamat Datang!</h1>
          <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" data-i18n="login_subtitle">Siap untuk meningkatkan level keuanganmu?</p>
        </div>
        <form onsubmit="handleLogin(event)" class="space-y-5">
          <div><label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 ms-1" data-i18n="username">Username</label><input type="text" placeholder="Insert Username" id="username" class="w-full p-3.5 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-primary dark:text-white transition-all text-start" required></div>
          <div><label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 ms-1" data-i18n="password">Password</label><input type="password" placeholder="Insert Password" id="password" class="w-full p-3.5 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-primary dark:text-white transition-all text-start" required></div>
          <button type="submit" id="btn-login" class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg transform active:scale-[0.98] transition-all mt-4" data-i18n="btn_login">Masuk Sekarang</button>
        </form>
        <p class="text-center text-xs text-slate-400 mt-8"><span data-i18n="app_name">DompetKu Pro</span> ¬© <span id="current-year"></span></p>
      </div>
    </div>
  </div>

  <aside id="sidebar" class="fixed inset-y-0 start-0 z-50 w-64 bg-white dark:bg-darkcard border-e border-slate-200 dark:border-slate-700 flex flex-col shadow-2xl md:shadow-none h-full overflow-hidden">
    <div class="h-20 flex items-center px-6 border-b border-slate-100 dark:border-slate-700/50 sidebar-header whitespace-nowrap overflow-hidden justify-between md:justify-start">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0 text-white"><i class="fa-solid fa-wallet"></i></div>
        <span class="logo-text font-bold text-lg tracking-tight" data-i18n="app_name">DompetKu Pro</span>
      </div>
      <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
    </div>
    <nav class="flex-1 p-3 space-y-1 overflow-y-auto overflow-x-hidden">
      <p class="nav-text px-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 mt-4" data-i18n="menu">Menu</p>
      <button onclick="nav('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-500 hover:bg-indigo-50 dark:hover:bg-slate-800 transition-colors group whitespace-nowrap"><i class="fa-solid fa-chart-pie w-6 text-center group-hover:text-primary"></i> <span class="nav-text" data-i18n="nav_dashboard">Dashboard</span></button>
      <button onclick="nav('transaksi')" id="nav-transaksi" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-500 hover:bg-indigo-50 dark:hover:bg-slate-800 transition-colors group whitespace-nowrap"><i class="fa-solid fa-money-bill-transfer w-6 text-center group-hover:text-primary"></i> <span class="nav-text" data-i18n="nav_transaction">Transaksi</span></button>
      <button onclick="nav('input')" id="nav-input" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-500 hover:bg-indigo-50 dark:hover:bg-slate-800 transition-colors group whitespace-nowrap"><i class="fa-solid fa-database w-6 text-center group-hover:text-primary"></i> <span class="nav-text" data-i18n="nav_master">Master Data</span></button>
      <button onclick="nav('laporan')" id="nav-laporan" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-500 hover:bg-indigo-50 dark:hover:bg-slate-800 transition-colors group whitespace-nowrap"><i class="fa-solid fa-file-invoice w-6 text-center group-hover:text-primary"></i> <span class="nav-text" data-i18n="nav_report">Laporan</span></button>
      <button onclick="nav('profile')" id="nav-profile" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-500 hover:bg-indigo-50 dark:hover:bg-slate-800 transition-colors group whitespace-nowrap"><i class="fa-solid fa-user-gear w-6 text-center group-hover:text-primary"></i> <span class="nav-text" data-i18n="nav_profile">Profil</span></button>
    </nav>
    <div class="p-4 border-t border-slate-100 dark:border-slate-700 whitespace-nowrap overflow-hidden">
      <button onclick="logout()" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"><i class="fa-solid fa-right-from-bracket w-6 text-center"></i> <span class="nav-text" data-i18n="nav_logout">Keluar</span></button>
    </div>
  </aside>

  <div id="backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm transition-opacity opacity-0"></div>

  <div id="main-content" class="flex-1 flex flex-col h-full w-full relative">
    <header class="h-20 bg-white/90 dark:bg-darkcard/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 flex justify-between items-center px-6 sticky top-0 z-30">
      <div class="flex items-center gap-4">
        <button onclick="toggleSidebar()" class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg active:scale-90 transition-transform"><i class="fa-solid fa-bars text-xl"></i></button>
        <h2 id="page-title" class="text-xl font-bold tracking-wide" data-i18n="nav_dashboard">Dashboard</h2>
      </div>
      
      <div class="relative flex items-center" id="dashboard-settings-container"> 
        <button onclick="toggleDashboardSettings()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors shadow-sm" title="Pengaturan">
          <i class="fa-solid fa-gear"></i>
        </button>
        <div id="dashboard-settings-dropdown" class="hidden absolute end-0 top-12 mt-1 w-52 bg-white dark:bg-darkcard rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 z-50 overflow-hidden transform transition-all">
          <div class="py-2 flex flex-col">
            <button onclick="toggleLang()" class="flex items-center justify-between w-full px-4 py-3 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
              <div class="flex items-center gap-3"><i class="fa-solid fa-earth-americas w-4 text-center"></i> <span data-i18n="language">Bahasa</span></div>
              <span id="lang-indicator" class="flex items-center gap-1 text-[10px] font-bold bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 px-2 py-1 rounded-lg shadow-sm"><span class="fi fi-id rounded-sm"></span> ID</span>
            </button>
            <button onclick="toggleNominal()" class="flex items-center justify-between w-full px-4 py-3 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors border-t dark:border-slate-700">
              <div class="flex items-center gap-3"><i id="eye-icon-menu" class="fa-solid fa-eye w-4 text-center"></i> <span data-i18n="hide_nominal">Sensor Saldo</span></div>
            </button>
            <button onclick="toggleTheme()" class="flex items-center justify-between w-full px-4 py-3 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors border-t dark:border-slate-700">
              <div class="flex items-center gap-3"><i class="fa-solid fa-palette w-4 text-center"></i> <span data-i18n="theme">Tema</span></div>
              <div class="relative w-9 h-5 flex items-center bg-slate-200 dark:bg-slate-700 rounded-full p-1 transition-colors duration-300 focus:outline-none shadow-inner shrink-0">
                  <div class="w-3 h-3 bg-white dark:bg-indigo-400 rounded-full shadow transform transition-transform duration-300 dark:translate-x-0 ltr:translate-x-4 rtl:-translate-x-4"></div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 dark:bg-darkbg">

      <div id="view-dashboard" class="fade-up">
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-6">
          <div class="p-6 bg-white dark:bg-darkcard rounded-3xl shadow-sm border-s-4 border-purple-500 bounce-hover bounce-card cursor-pointer group">
            <div class="flex justify-between items-start gap-2">
              <div class="flex-1 min-w-0">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-purple-500 transition-colors truncate" data-i18n="card_available">DANA AVAILABLE</p>
                <h3 class="text-2xl md:text-3xl font-bold tracking-tight truncate nominal-card-value text-start" id="val-card1">Rp 0</h3>
              </div>
              <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-2xl text-purple-500 shrink-0"><i class="fa-solid fa-hand-holding-dollar text-xl"></i></div>
            </div>
          </div>
          <div class="p-6 bg-white dark:bg-darkcard rounded-3xl shadow-sm border-s-4 border-red-500 bounce-hover bounce-card cursor-pointer group">
            <div class="flex justify-between items-start gap-2">
              <div class="flex-1 min-w-0">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-red-500 transition-colors truncate" data-i18n="card_expense">PENGELUARAN</p>
                <h3 class="text-2xl md:text-3xl font-bold tracking-tight truncate nominal-card-value text-start" id="val-card2">Rp 0</h3>
              </div>
              <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-2xl text-red-500 shrink-0"><i class="fa-solid fa-wallet text-xl"></i></div>
            </div>
          </div>
          <div class="p-6 bg-white dark:bg-darkcard rounded-3xl shadow-sm border-s-4 border-amber-500 bounce-hover bounce-card cursor-pointer group">
            <div class="flex justify-between items-start gap-2">
              <div class="flex-1 min-w-0">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-amber-500 transition-colors truncate" data-i18n="card_planning">DANA PLANNING</p>
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white mt-1 truncate nominal-card-value text-start" id="val-card3">Rp 0</h3>
              </div>
              <div class="p-3 bg-amber-50 dark:bg-amber-900/20 rounded-2xl text-amber-500 shrink-0"><i class="fa-solid fa-file-invoice-dollar text-xl"></i></div>
            </div>
          </div>
          <div class="p-6 bg-white dark:bg-darkcard rounded-3xl shadow-sm border-s-4 border-emerald-500 bounce-hover bounce-card cursor-pointer group">
            <div class="flex justify-between items-start gap-2">
              <div class="flex-1 min-w-0">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-emerald-500 transition-colors truncate" data-i18n="card_investment">INVESTASI</p>
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white mt-1 truncate nominal-card-value text-start" id="val-card4">Rp 0</h3>
              </div>
              <div class="p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-2xl text-emerald-500 shrink-0"><i class="fa-solid fa-gem text-xl"></i></div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
          <div class="bg-white dark:bg-darkcard p-6 rounded-3xl shadow-sm h-[380px] flex flex-col ">
            <h3 class="font-bold text-slate-700 dark:text-white mb-2 flex items-center gap-2"><i class="fa-solid fa-scale-balanced text-primary"></i> <span data-i18n="chart_cashflow">Cashflow</span></h3>
            <div class="flex-1 relative min-h-0" dir="ltr"><canvas id="chartDashboardDonut"></canvas></div>
          </div>
          <div class="xl:col-span-2 bg-white dark:bg-darkcard p-6 rounded-3xl shadow-sm h-[380px] flex flex-col">
            <h3 class="font-bold text-slate-700 dark:text-white mb-2 flex items-center gap-2"><i class="fa-solid fa-chart-line text-primary"></i> <span data-i18n="chart_trend30">Tren 30 Hari</span></h3>
            <div class="flex-1 relative min-h-0" dir="ltr"><canvas id="chartLine"></canvas></div>
          </div>
        </div>
        
        <div class="bg-white dark:bg-darkcard rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden bounce-card">
          <div class="p-6 border-b dark:border-slate-700 flex justify-between items-center">
            <h3 class="font-bold text-slate-700 dark:text-white flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-primary"></i> <span data-i18n="recent_trx">Transaksi Terakhir</span></h3>
            <button onclick="nav('laporan')" class="text-xs font-bold text-primary hover:underline" data-i18n="see_all">Lihat Semua</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-start">
              <thead class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 text-sm uppercase font-bold">
                <tr>
                  <th class="p-4 text-start" data-i18n="th_date">Tanggal</th>
                  <th class="p-4 text-start" data-i18n="th_type">Tipe</th>
                  <th class="p-4 text-start" data-i18n="th_source">Sumber Dana</th>
                  <th class="p-4 text-start" data-i18n="th_desc">Keterangan</th>
                  <th class="p-4 text-end" data-i18n="th_amount">Nominal</th>
                </tr>
              </thead>
              <tbody id="dashboard-recent-table" class="text-base divide-y divide-slate-100 dark:divide-slate-700">
                <tr><td colspan="5" class="p-6 text-center text-slate-400" data-i18n="loading_data">Memuat...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="view-profile" class="hidden fade-up max-w-md mx-auto pt-10">
        <div class="bg-white dark:bg-darkcard rounded-3xl shadow-lg border border-slate-100 dark:border-slate-700 overflow-hidden">
          <div class="p-8 border-b dark:border-slate-700 text-center">
            <div class="w-20 h-20 bg-indigo-100 dark:bg-indigo-900/50 rounded-full flex items-center justify-center mx-auto mb-4 text-primary text-3xl"><i class="fa-solid fa-user-shield"></i></div>
            <h2 class="font-bold text-xl dark:text-white" data-i18n="change_password">Ganti Password</h2>
          </div>
          <form onsubmit="submitChangePassword(event)" class="p-8 space-y-5">
            <div><label class="block text-xs font-bold text-slate-400 uppercase" data-i18n="old_password">Password Lama</label><input type="password" placeholder="Input Old Password" id="old-pass" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-primary mt-1 text-start" required></div>
            <div><label class="block text-xs font-bold text-slate-400 uppercase" data-i18n="new_password">Password Baru</label><input type="password" placeholder="Input New Password" id="new-pass" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-primary mt-1 text-start" required></div>
            <div><label class="block text-xs font-bold text-slate-400 uppercase" data-i18n="confirm_password">Konfirmasi</label><input type="password" placeholder="Repeat New Password" id="confirm-pass" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-primary mt-1 text-start" required></div>
            <button type="submit" id="btn-change-pass" class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-lg transform active:scale-95 transition-transform mt-4" data-i18n="btn_save">Simpan</button>
          </form>
        </div>
      </div>

      <div id="view-transaksi" class="hidden fade-up max-w-2xl mx-auto pb-10">
        <div class="bg-white dark:bg-darkcard rounded-3xl shadow-lg border border-slate-100 dark:border-slate-700 overflow-hidden group">
          <div class="p-6 bg-slate-50 dark:bg-slate-800/50 border-b dark:border-slate-700"><h2 class="font-bold text-lg" data-i18n="input_trx">Input Transaksi</h2></div>
          <form id="form-transaksi" onsubmit="submitTransaksi(event)" class="p-6 space-y-6">
            <div class="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-xl gap-1">
              <button type="button" onclick="setJenis('Masuk')" id="btn-masuk" class="flex-1 py-3 rounded-lg font-bold text-sm text-slate-500 transition-colors" data-i18n="btn_income">Masuk</button>
              <button type="button" onclick="setJenis('Keluar')" id="btn-keluar" class="flex-1 py-3 rounded-lg font-bold text-sm text-slate-500 transition-colors" data-i18n="btn_expense">Keluar</button>
              <button type="button" onclick="setJenis('Transfer')" id="btn-transfer" class="flex-1 py-3 rounded-lg font-bold text-sm text-slate-500 transition-colors" data-i18n="btn_transfer">Transfer</button>
              <input type="hidden" name="t_jenis" id="t_jenis" value="Keluar">
            </div>
            
            <div class="relative">
              <span class="absolute start-4 top-4 text-slate-400 font-bold text-lg">Rp</span>
              <input type="text" name="t_nominal" id="t_nominal" onkeyup="formatCurrency(this)" class="w-full text-3xl font-bold ps-12 pe-4 py-3 border-b-2 border-slate-200 dark:border-slate-600 bg-transparent outline-none focus:border-primary transition-colors text-start" dir="ltr" placeholder="0" required>
            </div>
            <p id="error-saldo" class="text-red-500 text-xs font-bold hidden animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> <span data-i18n="err_balance">Saldo tidak cukup!</span></p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label class="text-xs font-bold text-slate-400 uppercase" data-i18n="th_date">Tanggal</label><input type="date" name="t_tanggal" id="t_tanggal" class="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded-xl outline-none text-start" required></div>
              <div><label class="text-xs font-bold text-slate-400 uppercase" id="label-sumber" data-i18n="from_account">Dari Akun</label><select name="t_sumber" id="t_sumber" onchange="validateBalance()" class="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded-xl outline-none" required><option>Loading...</option></select></div>
            </div>
            <div id="div-tujuan" class="hidden"><label class="text-xs font-bold text-blue-500 uppercase" data-i18n="to_account">Ke Akun</label><select name="t_tujuan_transfer" id="t_tujuan" class="w-full p-3 bg-blue-50 dark:bg-slate-800 border border-blue-200 dark:border-blue-700 rounded-xl outline-none font-bold text-blue-800 dark:text-blue-100"><option>Loading...</option></select></div>
            <div id="div-kategori"><label class="text-xs font-bold text-slate-400 uppercase" data-i18n="category">Kategori</label><select name="t_kategori" class="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded-xl outline-none"></select></div>
            <div id="div-keterangan-container">
              <label class="text-xs font-bold text-slate-400 uppercase" data-i18n="th_desc">Keterangan</label>
              <input type="text" id="input-keterangan-text" name="t_keterangan" placeholder="Isi Keterangan Transaksi" class="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded-xl outline-none uppercase" required>
              <select id="input-keterangan-select" class="hidden w-full p-3 bg-indigo-50 dark:bg-slate-800 border border-indigo-200 dark:border-indigo-700 rounded-xl outline-none font-bold text-indigo-800 mb-2"><option>Loading...</option></select>
              <input type="text" id="input-keterangan-manual" placeholder="Isi Keterangan Transaksi" name="t_manual" class="hidden w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded-xl outline-none uppercase mt-2">
            </div>
            <button type="submit" id="btn-save-trx" class="w-full bg-slate-800 hover:bg-slate-900 dark:bg-primary dark:hover:bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg transform active:scale-95 transition-transform disabled:bg-gray-400 disabled:cursor-not-allowed" data-i18n="btn_save_trx">Simpan Transaksi</button>
          </form>
        </div>
      </div>

      <div id="view-input" class="hidden fade-up pb-10">
        <div class="mb-6 relative">
          <i class="fa-solid fa-layer-group absolute start-4 top-3.5 text-slate-400 z-10 pointer-events-none"></i>
          <select id="master-type-select" onchange="switchMaster(this.value)" class="w-full ps-11 pe-4 py-3 bg-white dark:bg-darkcard border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-slate-600 dark:text-slate-300 font-bold focus:ring-2 focus:ring-primary appearance-none shadow-sm cursor-pointer transition-all hover:border-primary">
              <option value="bank" data-i18n="opt_bank">üè¶   Bank</option>
              <option value="ewallet" data-i18n="opt_ewallet">üì±   E-Wallet</option>
              <option value="tunai" data-i18n="opt_cash">üíµ   Tunai</option>
              <option value="investasi" data-i18n="opt_invest">üíé   Investasi</option>
              <option value="tabungan" data-i18n="opt_saving">üê∑   Tabungan</option>
              <option value="hutang" data-i18n="opt_debt">üßæ   Hutang</option>
              <option value="piutang" data-i18n="opt_receivable">ü§≤   Piutang</option>
              <option value="rencana" data-i18n="opt_plan">üìÖ   Rencana</option>
            </select>
          <i class="fa-solid fa-chevron-down absolute end-4 top-4 text-slate-400 pointer-events-none"></i>
        </div>

        <div id="investasi-summary-container" class="hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6"></div>

        <div id="master-summary-card" class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-3xl p-6 text-white shadow-lg mb-6 relative overflow-hidden transition-all duration-500 bounce-card">
          <div class="relative z-10 flex justify-between items-center">
            <div>
              <p class="text-xs font-bold opacity-80 uppercase tracking-widest mb-1" id="master-total-label">TOTAL BANK</p>
              <h3 class="text-3xl md:text-4xl font-bold tracking-tight nominal-card-value text-start" dir="ltr" id="master-total-value">Rp 0</h3>
              <p class="text-[10px] opacity-70 mt-1" id="master-total-count">0 Data terdaftar</p>
            </div>
            <div class="p-4 bg-white/20 rounded-2xl backdrop-blur-sm"><i id="master-total-icon" class="fa-solid fa-building-columns text-3xl"></i></div>
          </div>
        </div>

        <button onclick="openModal()" class="mb-6 bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-3 rounded-xl text-sm font-bold shadow-lg flex items-center gap-2 transform active:scale-95 transition-transform"><i class="fa-solid fa-plus"></i> <span data-i18n="btn_add_data">Tambah Data</span></button>
        
        <div class="bg-white dark:bg-darkcard rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
          <div class="p-5 border-b dark:border-slate-700 flex justify-between gap-4">
            <div class="flex items-center gap-2">
              <span class="text-xs font-bold text-slate-400 uppercase" data-i18n="show">Show</span>
              <select id="table-limit" onchange="changeLimit(this.value)" class="bg-slate-50 dark:bg-slate-800 border dark:border-slate-600 rounded-lg text-xs p-2 font-bold"><option value="5">5</option><option value="10">10</option><option value="25">25</option></select>
            </div>
            <input type="text" id="table-search" onkeyup="handleSearch(this.value)" class="p-2.5 px-4 bg-slate-50 dark:bg-slate-800 border dark:border-slate-600 rounded-xl text-sm w-full md:w-64" placeholder="Search...">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-start">
              <thead class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 text-sm uppercase font-bold"><tr id="table-head-row"></tr></thead>
              <tbody id="table-body-master" class="text-base divide-y divide-slate-100 dark:divide-slate-700"></tbody>
            </table>
          </div>
          <div class="p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
            <span id="page-info" class="text-xs font-bold text-slate-400">...</span>
            <div class="flex gap-2">
              <button id="btn-prev" onclick="changePage(-1)" class="px-3 py-1.5 rounded-lg bg-white dark:bg-slate-700 border dark:border-slate-600 text-xs font-bold" data-i18n="btn_prev">Prev</button>
              <button id="btn-next" onclick="changePage(1)" class="px-3 py-1.5 rounded-lg bg-white dark:bg-slate-700 border dark:border-slate-600 text-xs font-bold" data-i18n="btn_next">Next</button>
            </div>
          </div>
        </div>
      </div>

      <div id="view-laporan" class="hidden fade-up pb-10">
        <div class="bg-white dark:bg-darkcard p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 group">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div><label class="text-xs font-bold text-slate-400 uppercase" data-i18n="from_date">Dari</label><input type="date" id="filter-start" class="w-full p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-600 rounded-xl text-sm mt-1 text-start"></div>
            <div><label class="text-xs font-bold text-slate-400 uppercase" data-i18n="to_date">Sampai</label><input type="date" id="filter-end" class="w-full p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-600 rounded-xl text-sm mt-1 text-start"></div>
            <div><label class="text-xs font-bold text-slate-400 uppercase" data-i18n="category">Kategori</label><select id="filter-category" class="w-full p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-600 rounded-xl text-sm mt-1"><option value="">Semua</option></select></div>
            <div class="flex items-end gap-2">
              <button onclick="loadReport()" class="flex-1 bg-slate-800 dark:bg-primary text-white font-bold py-2.5 rounded-xl shadow mt-1 hover:opacity-90 transform active:scale-95 transition-transform" data-i18n="btn_filter">Filter</button>
              <button onclick="resetReportFilter()" class="w-12 bg-gray-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold py-2.5 rounded-xl shadow mt-1 hover:bg-gray-300 dark:hover:bg-slate-600 transform active:scale-95 transition-transform" title="Reset"><i class="fa-solid fa-rotate-left"></i></button>
              <button onclick="exportToExcel()" class="w-12 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2.5 rounded-xl shadow mt-1 transform active:scale-95 transition-transform" title="Export Excel"><i class="fa-solid fa-file-excel"></i></button>
            </div>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-slate-50 dark:bg-slate-800/50 p-5 rounded-3xl border dark:border-slate-600 h-96 flex flex-col">
              <h4 class="font-bold text-xs text-slate-500 dark:text-slate-400 mb-4 uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-chart-line text-primary"></i> <span data-i18n="chart_trend_monthly">Tren Bulanan</span></h4>
              <div class="flex-1 relative min-h-0" dir="ltr"><canvas id="chartReportLine"></canvas></div>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800/50 p-5 rounded-3xl border dark:border-slate-600 h-96 flex flex-col">
              <h4 class="font-bold text-xs text-slate-500 dark:text-slate-400 mb-4 uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-chart-pie text-primary"></i> <span data-i18n="chart_proportion">Proporsi Kategori</span></h4>
              <div class="flex-1 relative min-h-0" dir="ltr"><canvas id="chartReportPie"></canvas></div>
            </div>
          </div>
          
          <div class="border-t dark:border-slate-700 pt-4 mb-4 flex justify-between">
            <select id="report-limit" onchange="changeReportLimit(this.value)" class="bg-slate-50 dark:bg-slate-800 border dark:border-slate-600 rounded-lg text-xs p-1.5 font-bold"><option value="5">5</option><option value="10">10</option><option value="25">25</option></select>
            <span id="report-total-badge" class="text-xs font-bold bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full">0 Data</span>
          </div>
          <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
            <table class="w-full text-start">
              <thead class="bg-slate-50 dark:bg-slate-800 text-slate-500 text-sm uppercase font-bold">
                <tr>
                  <th class="p-4 text-start">No</th>
                  <th class="p-4 text-start" data-i18n="th_date">Tanggal</th>
                  <th class="p-4 text-start" data-i18n="th_type">Tipe</th>
                  <th class="p-4 text-start" data-i18n="th_source">Sumber Dana</th>
                  <th class="p-4 text-start" data-i18n="th_desc">Keterangan</th>
                  <th class="p-4 text-end" data-i18n="th_amount">Nominal</th>
                </tr>
              </thead>
              <tbody id="report-body" class="text-base divide-y divide-slate-100 dark:divide-slate-700"></tbody>
            </table>
          </div>
          <div class="mt-4 flex justify-between items-center">
            <span id="report-page-info" class="text-xs font-bold text-slate-400">...</span>
            <div class="flex gap-2">
              <button id="btn-report-prev" onclick="changeReportPage(-1)" class="px-3 py-1.5 rounded-lg bg-white dark:bg-slate-700 border dark:border-slate-600 text-xs font-bold" data-i18n="btn_prev">Prev</button>
              <button id="btn-report-next" onclick="changeReportPage(1)" class="px-3 py-1.5 rounded-lg bg-white dark:bg-slate-700 border dark:border-slate-600 text-xs font-bold" data-i18n="btn_next">Next</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="modal-form" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
    <div class="bg-white dark:bg-darkcard rounded-3xl shadow-2xl w-full max-w-md relative z-10 fade-up overflow-hidden">
      <div class="p-5 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
        <h3 class="font-bold" data-i18n="modal_input_title">Input Data</h3>
        <button onclick="closeModal()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
      </div>
      <form id="master-form" onsubmit="saveMaster(event)" class="p-6 space-y-4">
        <input type="hidden" name="id" id="f_id">
        <div id="form-fields" class="space-y-4"></div>
        <button type="submit" id="btn-save" class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 transform active:scale-95 transition-transform" data-i18n="btn_save">Simpan</button>
      </form>
    </div>
  </div>

  <div id="modal-payment" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closePaymentModal()"></div>
    <div class="bg-white dark:bg-darkcard rounded-3xl shadow-2xl w-full max-w-md relative z-10 fade-up overflow-hidden">
      <div class="p-5 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
        <h3 class="font-bold" id="payment-title" data-i18n="modal_payment_title">Proses Pembayaran</h3>
        <button onclick="closePaymentModal()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
      </div>
      <form id="payment-form" onsubmit="submitPayment(event)" class="p-6 space-y-4">
        <input type="hidden" name="p_id" id="p_id">
        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2 ms-1" data-i18n="pay_name">Nama Hutang/Piutang</label><input type="text" id="p_nama" class="w-full p-3 bg-slate-100 dark:bg-slate-900/50 border dark:border-slate-600 rounded-xl outline-none text-sm font-bold text-slate-500 text-start" readonly></div>
        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2 ms-1" data-i18n="pay_remaining">Sisa Tagihan</label><input type="text" id="p_sisa" class="w-full p-3 bg-slate-100 dark:bg-slate-900/50 border dark:border-slate-600 rounded-xl outline-none text-sm font-bold text-red-500 text-start" dir="ltr" readonly></div>
        <div>
          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ms-1" data-i18n="pay_amount">Nominal Bayar</label>
          <input type="text" name="p_nominal" id="p_nominal" onkeyup="formatCurrency(this)" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-xl outline-none text-sm font-bold focus:ring-2 focus:ring-primary text-start" dir="ltr" placeholder="0" required data-max="0">
          <p id="error-overpay" class="hidden text-red-500 text-xs font-bold mt-1" data-i18n="err_overpay">Nominal melebihi sisa tagihan!</p>
          <p id="error-saldo-pay" class="hidden text-red-500 text-xs font-bold mt-1"><i class="fa-solid fa-wallet"></i> <span data-i18n="err_balance">Saldo sumber dana tidak cukup!</span></p>
        </div>
        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2 ms-1" data-i18n="th_source">Sumber Dana</label><select name="p_sumber" id="p_sumber" onchange="validatePaymentInput()" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-xl outline-none text-sm focus:ring-2 focus:ring-primary" required><option value="">Loading...</option></select></div>
        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2 ms-1" data-i18n="pay_note">Keterangan Tambahan</label><input type="text" name="p_keterangan" placeholder="Isi Keterangan Transaksi" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-xl outline-none text-sm uppercase-input focus:ring-2 focus:ring-primary text-start"></div>
        <button type="submit" id="btn-pay" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 transform active:scale-95 transition-transform" data-i18n="btn_process">Proses</button>
      </form>
    </div>
  </div>

  <script>
    // ==========================================
    // 1. KAMUS BAHASA (i18n)
    // ==========================================
    const translations = {
        'id': {
            language: "Bahasa", hide_nominal: "Sensor Saldo", theme: "Tema Tampilan",
            app_name: "Isi Dompet", menu: "Menu",
            loading: "Memuat...", loading_data: "Memuat Data...",
            login_hero_title: "Raih Puncak Finansial!", login_hero_desc: "Kelola uangmu dengan cerdas, dan lihatlah grafiknya terus menanjak.",
            login_welcome: "Selamat Datang!", login_subtitle: "Siap untuk meningkatkan level keuanganmu?",
            username: "Username", password: "Password", btn_login: "Masuk Sekarang",
            nav_dashboard: "Dashboard", nav_transaction: "Transaksi", nav_master: "Master Data", nav_report: "Laporan", nav_profile: "Profil", nav_logout: "Keluar",
            card_available: "DANA AVAILABLE", card_expense: "PENGELUARAN", card_planning: "DANA PLANNING", card_investment: "INVESTASI",
            chart_cashflow: "Cashflow", chart_trend30: "Tren 7 Hari", chart_trend_monthly: "Tren Bulanan", chart_proportion: "Proporsi Kategori",
            recent_trx: "Transaksi Terakhir", see_all: "Lihat Semua",
            th_date: "Tanggal", th_type: "Tipe", th_source: "Sumber Dana", th_desc: "Keterangan", th_amount: "Nominal",
            change_password: "Ganti Password", old_password: "Password Lama", new_password: "Password Baru", confirm_password: "Konfirmasi", btn_save: "Simpan",
            input_trx: "Input Transaksi", btn_income: "Masuk", btn_expense: "Keluar", btn_transfer: "Transfer",
            err_balance: "Saldo tidak cukup!", err_overpay: "Nominal melebihi sisa tagihan!",
            from_account: "Dari Akun", to_account: "Ke Akun", category: "Kategori", btn_save_trx: "Simpan Transaksi",
            opt_bank: "üè¶   Bank", opt_ewallet: "üì±   E-Wallet", opt_cash: "üíµ   Tunai", opt_invest: "üíé   Investasi", opt_saving: "üê∑   Tabungan", opt_debt: "üßæ   Hutang", opt_receivable: "ü§≤   Piutang", opt_plan: "üìÖ   Rencana",
            btn_add_data: "Tambah Data", show: "Tampil", btn_prev: "Seb", btn_next: "Lanjut",
            from_date: "Dari", to_date: "Sampai", btn_filter: "Filter",
            modal_input_title: "Input Data", modal_payment_title: "Proses Pembayaran",
            pay_name: "Nama Hutang/Piutang", pay_remaining: "Sisa Tagihan", pay_amount: "Nominal Bayar", pay_note: "Keterangan Tambahan", btn_process: "Proses",
            table_no_data: "Tidak Ada Data", table_empty: "Kosong",
            lbl_pay: "Bayar", lbl_receive: "Terima"
        },
        'en': {
            language: "Language", hide_nominal: "Hide Balance", theme: "Theme Mode",
            app_name: "Isi Dompet", menu: "Menu",
            loading: "Loading...", loading_data: "Loading Data...",
            login_hero_title: "Reach Financial Peak!", login_hero_desc: "Manage your money smartly, and watch your graph go up.",
            login_welcome: "Welcome Back!", login_subtitle: "Ready to level up your finances?",
            username: "Username", password: "Password", btn_login: "Login Now",
            nav_dashboard: "Dashboard", nav_transaction: "Transaction", nav_master: "Master Data", nav_report: "Report", nav_profile: "Profile", nav_logout: "Logout",
            card_available: "AVAILABLE FUNDS", card_expense: "EXPENSE", card_planning: "PLANNING FUNDS", card_investment: "INVESTMENT",
            chart_cashflow: "Cashflow", chart_trend30: "7 Days Trend", chart_trend_monthly: "Monthly Trend", chart_proportion: "Category Proportion",
            recent_trx: "Recent Transactions", see_all: "See All",
            th_date: "Date", th_type: "Type", th_source: "Source", th_desc: "Description", th_amount: "Amount",
            change_password: "Change Password", old_password: "Old Password", new_password: "New Password", confirm_password: "Confirm", btn_save: "Save",
            input_trx: "Input Transaction", btn_income: "Income", btn_expense: "Expense", btn_transfer: "Transfer",
            err_balance: "Insufficient balance!", err_overpay: "Amount exceeds remaining bill!",
            from_account: "From Account", to_account: "To Account", category: "Category", btn_save_trx: "Save Transaction",
            opt_bank: "üè¶   Bank", opt_ewallet: "üì±   E-Wallet", opt_cash: "üíµ   Cash", opt_invest: "üíé   Investment", opt_saving: "üê∑   Savings", opt_debt: "üßæ   Debt", opt_receivable: "ü§≤   Receivable", opt_plan: "üìÖ   Plan",
            btn_add_data: "Add Data", show: "Show", btn_prev: "Prev", btn_next: "Next",
            from_date: "From", to_date: "To", btn_filter: "Filter",
            modal_input_title: "Input Data", modal_payment_title: "Process Payment",
            pay_name: "Debt/Receivable Name", pay_remaining: "Remaining Bill", pay_amount: "Payment Amount", pay_note: "Additional Note", btn_process: "Process",
            table_no_data: "No Data", table_empty: "Empty",
            lbl_pay: "Pay", lbl_receive: "Receive"
        },
        'my': {
            language: "Bahasa", hide_nominal: "Sembunyikan Baki", theme: "Tema Tampilan",
            app_name: "Isi Dompet", menu: "Menu",
            loading: "Memuatkan...", loading_data: "Memuatkan Data...",
            login_hero_title: "Capai Puncak Kewangan!", login_hero_desc: "Urus wang anda dengan bijak, dan lihat graf terus meningkat.",
            login_welcome: "Selamat Datang!", login_subtitle: "Sedia untuk meningkatkan tahap kewangan anda?",
            username: "Nama Pengguna", password: "Kata Laluan", btn_login: "Log Masuk Sekarang",
            nav_dashboard: "Papan Pemuka", nav_transaction: "Transaksi", nav_master: "Data Induk", nav_report: "Laporan", nav_profile: "Profil", nav_logout: "Log Keluar",
            card_available: "DANA TERSEDIA", card_expense: "PERBELANJAAN", card_planning: "DANA PERANCANGAN", card_investment: "PELABURAN",
            chart_cashflow: "Aliran Tunai", chart_trend30: "Aliran 7 Hari", chart_trend_monthly: "Aliran Bulanan", chart_proportion: "Nisbah Kategori",
            recent_trx: "Transaksi Terkini", see_all: "Lihat Semua",
            th_date: "Tarikh", th_type: "Jenis", th_source: "Sumber Dana", th_desc: "Penerangan", th_amount: "Jumlah",
            change_password: "Tukar Kata Laluan", old_password: "Kata Laluan Lama", new_password: "Kata Laluan Baru", confirm_password: "Sahkan", btn_save: "Simpan",
            input_trx: "Input Transaksi", btn_income: "Pendapatan", btn_expense: "Perbelanjaan", btn_transfer: "Pindahan",
            err_balance: "Baki tidak mencukupi!", err_overpay: "Jumlah melebihi baki bil!",
            from_account: "Dari Akaun", to_account: "Ke Akaun", category: "Kategori", btn_save_trx: "Simpan Transaksi",
            opt_bank: "üè¶   Bank", opt_ewallet: "üì±   E-Dompet", opt_cash: "üíµ   Tunai", opt_invest: "üíé   Pelaburan", opt_saving: "üê∑   Simpanan", opt_debt: "üßæ   Hutang", opt_receivable: "ü§≤   Pemiutang", opt_plan: "üìÖ   Rancangan",
            btn_add_data: "Tambah Data", show: "Papar", btn_prev: "Sblm", btn_next: "Seterusnya",
            from_date: "Dari", to_date: "Hingga", btn_filter: "Tapis",
            modal_input_title: "Input Data", modal_payment_title: "Proses Pembayaran",
            pay_name: "Nama Hutang/Pemiutang", pay_remaining: "Baki Bil", pay_amount: "Jumlah Bayaran", pay_note: "Nota Tambahan", btn_process: "Proses",
            table_no_data: "Tiada Data", table_empty: "Kosong",
            lbl_pay: "Bayar", lbl_receive: "Terima"
        },
        'ar': {
            language: "ÿßŸÑŸÑÿ∫ÿ©", hide_nominal: "ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ±ÿµŸäÿØ", theme: "ŸÖÿ∏Ÿáÿ±",
            app_name: "ŸÖÿ≠ŸÅÿ∏ÿ™Ÿä ÿ®ÿ±Ÿà", menu: "ÿßŸÑŸÇÿßÿ¶ŸÖÿ©",
            loading: "ÿ¨ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...", loading_data: "ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...",
            login_hero_title: "ŸÇŸÖ ÿ®ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÇŸÖÿ© ÿßŸÑŸÖÿßŸÑŸäÿ©!", login_hero_desc: "ÿ•ÿØÿßÿ±ÿ© ÿ£ŸÖŸàÿßŸÑŸÉ ÿ®ÿ∞ŸÉÿßÿ° Ÿàÿ¥ÿßŸáÿØ ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑÿ®ŸäÿßŸÜŸä Ÿäÿ±ÿ™ŸÅÿπ.",
            login_welcome: "ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ!", login_subtitle: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ≥ÿ™ÿπÿØ ŸÑÿ±ŸÅÿπ ŸÖÿ≥ÿ™ŸàŸâ ÿ£ŸÖŸàÿßŸÑŸÉÿü",
            username: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ", password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±", btn_login: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
            nav_dashboard: "ŸÑŸàÿ≠ÿ© ÿßŸÑŸÇŸäÿßÿØÿ©", nav_transaction: "ÿπŸÖŸÑŸäÿ© ÿ™ÿ¨ÿßÿ±Ÿäÿ©", nav_master: "ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©", nav_report: "ÿ™ŸÇÿ±Ÿäÿ±", nav_profile: "ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä", nav_logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨",
            card_available: "ÿßŸÑÿ£ŸÖŸàÿßŸÑ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©", card_expense: "ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™", card_planning: "ÿ£ŸÖŸàÿßŸÑ ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑", card_investment: "ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±",
            chart_cashflow: "ÿßŸÑÿ™ÿØŸÅŸÇ ÿßŸÑŸÜŸÇÿØŸä", chart_trend30: "ÿßÿ™ÿ¨ÿßŸá 7 ŸäŸàŸÖŸãÿß", chart_trend_monthly: "ÿßŸÑÿßÿ™ÿ¨ÿßŸá ÿßŸÑÿ¥Ÿáÿ±Ÿä", chart_proportion: "ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÅÿ¶ÿ©",
            recent_trx: "ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©", see_all: "ÿπÿ±ÿ∂ ÿßŸÑŸÉŸÑ",
            th_date: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ", th_type: "ÿßŸÑŸÜŸàÿπ", th_source: "ÿßŸÑŸÖÿµÿØÿ±", th_desc: "ÿßŸÑŸàÿµŸÅ", th_amount: "ÿßŸÑŸÖÿ®ŸÑÿ∫",
            change_password: "ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±", old_password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©", new_password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©", confirm_password: "ÿ™ÿ£ŸÉŸäÿØ", btn_save: "ÿ≠ŸÅÿ∏",
            input_trx: "ÿ•ÿØÿÆÿßŸÑ ŸÖÿπÿßŸÖŸÑÿ©", btn_income: "ÿØÿÆŸÑ", btn_expense: "ŸÖÿµÿ±ŸàŸÅ", btn_transfer: "ÿ™ÿ≠ŸàŸäŸÑ",
            err_balance: "ÿ±ÿµŸäÿØ ÿ∫Ÿäÿ± ŸÉÿßŸÅ!", err_overpay: "ÿßŸÑŸÖÿ®ŸÑÿ∫ Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©!",
            from_account: "ŸÖŸÜ ÿ≠ÿ≥ÿßÿ®", to_account: "ÿ•ŸÑŸâ ÿ≠ÿ≥ÿßÿ®", category: "ÿßŸÑŸÅÿ¶ÿ©", btn_save_trx: "ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©",
            opt_bank: "üè¶   ÿ®ŸÜŸÉ", opt_ewallet: "üì±   ŸÖÿ≠ŸÅÿ∏ÿ© ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿ©", opt_cash: "üíµ   ŸÜŸÇÿØŸä", opt_invest: "üíé   ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±", opt_saving: "üê∑   ŸÖÿØÿÆÿ±ÿßÿ™", opt_debt: "üßæ   ÿØŸäŸÜ", opt_receivable: "ü§≤   ŸÖÿ≥ÿ™ÿ≠ŸÇÿßÿ™", opt_plan: "üìÖ   ÿÆÿ∑ÿ©",
            btn_add_data: "ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™", show: "ÿπÿ±ÿ∂", btn_prev: "ÿßŸÑÿ≥ÿßÿ®ŸÇ", btn_next: "ÿßŸÑÿ™ÿßŸÑŸä",
            from_date: "ŸÖŸÜ", to_date: "ÿ•ŸÑŸâ", btn_filter: "ÿ™ÿµŸÅŸäÿ©",
            modal_input_title: "ÿ•ÿØÿÆÿßŸÑ ÿ®ŸäÿßŸÜÿßÿ™", modal_payment_title: "ÿπŸÖŸÑŸäÿ© ÿßŸÑÿØŸÅÿπ",
            pay_name: "ÿßÿ≥ŸÖ ÿßŸÑÿØŸäŸÜ / ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ", pay_remaining: "ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©", pay_amount: "ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿØŸÅÿπ", pay_note: "ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©", btn_process: "ŸÖÿπÿßŸÑÿ¨ÿ©",
            table_no_data: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™", table_empty: "ŸÅÿßÿ±ÿ∫",
            lbl_pay: "ÿØŸÅÿπ", lbl_receive: "Ÿäÿ≥ÿ™ŸÑŸÖ"
        }
    };

    let currentLang = localStorage.getItem('appLang') || 'id';

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('appLang', lang);
        
        // Logical LTR/RTL Setter
        if (lang === 'ar') {
            document.documentElement.setAttribute('dir', 'rtl');
            document.documentElement.setAttribute('lang', 'ar');
        } else {
            document.documentElement.setAttribute('dir', 'ltr');
            document.documentElement.setAttribute('lang', lang);
        }
        
        const langFlags = { 
            'id': '<span class="fi fi-id rounded-sm"></span> ID', 
            'en': '<span class="fi fi-gb rounded-sm"></span> EN', 
            'my': '<span class="fi fi-my rounded-sm"></span> MY', 
            'ar': '<span class="fi fi-sa rounded-sm"></span> AR' 
        };

        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang][key]) el.innerText = translations[lang][key];
        });
        
        const ind = document.getElementById('lang-indicator');
        const indLog = document.getElementById('lang-indicator-login');
        if(ind) ind.innerHTML = langFlags[lang];
        if(indLog) indLog.innerHTML = langFlags[lang];

        const sel = document.getElementById('master-type-select');
        if(sel) {
            Array.from(sel.options).forEach(opt => {
                const key = opt.getAttribute('data-i18n');
                if(key && translations[lang][key]) opt.innerText = translations[lang][key];
            });
        }
        
        if(tableDataFiltered.length >= 0 && !document.getElementById('view-input').classList.contains('hidden')) renderTableSlice();
        if(reportDataRaw.length >= 0 && !document.getElementById('view-laporan').classList.contains('hidden')) renderReportSlice();
    }

    function toggleLang() {
        const langs = ['id', 'en', 'my', 'ar'];
        let currentIndex = langs.indexOf(currentLang);
        let nextIndex = (currentIndex + 1) % langs.length;
        setLanguage(langs[nextIndex]);
    }

    // ==========================================
    // 2. CORE UTILS & SETUP
    // ==========================================
    
    // Toggling Menu Dropdown (Settings)
    function toggleDashboardSettings() { document.getElementById('dashboard-settings-dropdown').classList.toggle('hidden'); }
    function toggleLoginSettings() { document.getElementById('login-settings-dropdown').classList.toggle('hidden'); }

    // Close dropdown on outside click
    window.addEventListener('click', function(e) {
        if (!e.target.closest('#dashboard-settings-container')) {
            const dd = document.getElementById('dashboard-settings-dropdown');
            if(dd && !dd.classList.contains('hidden')) dd.classList.add('hidden');
        }
        if (!e.target.closest('#login-settings-container')) {
            const ddLog = document.getElementById('login-settings-dropdown');
            if(ddLog && !ddLog.classList.contains('hidden')) ddLog.classList.add('hidden');
        }
    });

    function showLoader(msgKey="loading") { 
        document.getElementById('loader-text').innerText = translations[currentLang][msgKey] || "Memuat..."; 
        document.getElementById('global-loader').classList.remove('hidden'); 
    }
    function hideLoader() { document.getElementById('global-loader').classList.add('hidden'); }
    
    function initTheme(){ 
        if(localStorage.theme==='dark'||(!('theme'in localStorage)&&window.matchMedia('(prefers-color-scheme: dark)').matches)){
            document.documentElement.classList.add('dark');
        }else{
            document.documentElement.classList.remove('dark');
        } 
    }
    
    function toggleTheme(){ 
        document.documentElement.classList.toggle('dark'); 
        if(document.documentElement.classList.contains('dark')){ localStorage.theme='dark'; }else{ localStorage.theme='light'; } 
        const viewDashboard = document.getElementById('view-dashboard');
        if (!viewDashboard.classList.contains('hidden')) { loadDashboard(); }
    }
    
    function initNominalState() {
        if (localStorage.getItem('hideNominal') === 'true') {
            document.body.classList.add('hide-values');
            const icons = document.querySelectorAll('#eye-icon-menu');
            icons.forEach(i => i.className = 'fa-solid fa-eye-slash w-4 text-center');
        }
    }
    
    function toggleNominal() {
        const body = document.body; body.classList.toggle('hide-values');
        const icons = document.querySelectorAll('#eye-icon-menu');
        if (body.classList.contains('hide-values')) { 
            icons.forEach(i => i.className = 'fa-solid fa-eye-slash w-4 text-center'); 
            localStorage.setItem('hideNominal', 'true'); 
        } else { 
            icons.forEach(i => i.className = 'fa-solid fa-eye w-4 text-center'); 
            localStorage.setItem('hideNominal', 'false'); 
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => { 
        initTheme();
        initNominalState(); 
        setLanguage(currentLang); 
        document.getElementById('current-year').textContent = new Date().getFullYear();
    });

    // Logical approach for sidebar RTL sliding (100% bug-free)
    function toggleSidebar(){ 
        const body = document.body; 
        const bd = document.getElementById('backdrop');
        if(window.innerWidth < 768) { 
            if(body.classList.contains('mobile-sidebar-open')) { 
                body.classList.remove('mobile-sidebar-open'); 
                bd.classList.add('hidden'); 
            } else { 
                body.classList.add('mobile-sidebar-open'); 
                bd.classList.remove('hidden'); 
                setTimeout(()=>bd.classList.remove('opacity-0'),10); 
            } 
        } else { 
            body.classList.toggle('sidebar-collapsed'); 
            setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 350); 
        } 
    }
    
    function nav(v){ 
        document.querySelectorAll('#view-dashboard, #view-transaksi, #view-input, #view-laporan, #view-profile').forEach(el=>el.classList.add('hidden')); 
        document.getElementById('view-'+v).classList.remove('hidden'); 
        document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('bg-indigo-50','dark:bg-slate-800','text-primary'); b.classList.add('text-slate-500'); b.querySelector('i').classList.remove('text-primary'); }); 
        const ab = document.getElementById('nav-'+v); 
        if(ab){ ab.classList.add('bg-indigo-50','dark:bg-slate-800','text-primary'); ab.classList.remove('text-slate-500'); ab.querySelector('i').classList.add('text-primary'); }
        
        let titleKey = 'nav_' + v;
        if(v === 'input') titleKey = 'nav_master';
        document.getElementById('page-title').innerText = translations[currentLang][titleKey] || v.toUpperCase(); 
        
        if(window.innerWidth<768) { 
            document.body.classList.remove('mobile-sidebar-open'); 
            document.getElementById('backdrop').classList.add('hidden'); 
        } 
        
        if(v==='dashboard') loadDashboard(); 
        if(v==='transaksi'){ loadAccountSources(); setJenis('Keluar'); document.getElementById('t_tanggal').valueAsDate=new Date();} 
        if(v==='input') switchMaster('bank'); 
        if(v==='laporan') { loadCategories(); loadReport(); }
    }

    let currentUser = '';
    let currentMasterType='bank', tableDataRaw=[], tableDataFiltered=[], currentPage=1, rowsPerPage=5;
    let reportDataRaw=[], reportPage=1, reportRowsPerPage=5;
    let myLineChart=null, myPieChart=null, myReportLine=null, myReportPie=null;
    let localDataTimestamp = '0'; 
    let autoRefreshInterval = null;

    const listKategori = {'Masuk': ['GAJI BULANAN','BONUS / THR','PENCAIRAN HUTANG','PELUNASAN PIUTANG','PROFIT BISNIS','LAINNYA'],'Keluar': ['MAKAN & MINUM','TRANSPORTASI','BELANJA BULANAN','TAGIHAN / LISTRIK','BAYAR RENCANA','CICILAN HUTANG','PEMBERIAN PIUTANG','HIBURAN','LAINNYA']};
    const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    function formatCurrency(input) { let value = input.value.replace(/\D/g, ''); input.value = value ? new Intl.NumberFormat('id-ID').format(value) : ''; if(input.id === 'p_nominal') validatePaymentInput(); if(input.id === 't_nominal') validateBalance(); }
    
    function validatePaymentInput() {
        const input = document.getElementById('p_nominal');
        const val = parseFloat(input.value.replace(/\./g, '').replace(/,/g, '.')) || 0;
        const max = parseFloat(input.dataset.max) || 0;
        const btn = document.getElementById('btn-pay');
        const errOver = document.getElementById('error-overpay');
        const errSaldo = document.getElementById('error-saldo-pay');
        const sumberSelect = document.getElementById('p_sumber');
        let isValid = true;
        if (val > max) { errOver.classList.remove('hidden'); isValid = false; } else { errOver.classList.add('hidden'); }
        if (currentMasterType === 'hutang' && sumberSelect.value && isValid) {
            try {
                const sourceData = JSON.parse(sumberSelect.value); const currentBalance = parseFloat(sourceData.balance) || 0;
                if (val > currentBalance) { errSaldo.innerHTML = `<i class="fa-solid fa-wallet"></i> ${translations[currentLang]['err_balance']} (${formatRupiah(currentBalance)})`; errSaldo.classList.remove('hidden'); isValid = false; } else { errSaldo.classList.add('hidden'); }
            } catch (e) { }
        } else { errSaldo.classList.add('hidden'); }
        if (!isValid) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); input.classList.add('border-red-500', 'text-red-500'); } 
        else { btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); input.classList.remove('border-red-500', 'text-red-500'); }
    }

    function validateBalance() { 
        const jenis = document.getElementById('t_jenis').value; 
        const nominalStr = document.getElementsByName('t_nominal')[0].value.replace(/\D/g, ''); 
        const nominal = parseInt(nominalStr) || 0; 
        const sumberEl = document.getElementById('t_sumber'); 
        const btn = document.getElementById('btn-save-trx'); 
        const errEl = document.getElementById('error-saldo'); 
        const inputEl = document.getElementById('t_nominal'); 
        btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); errEl.classList.add('hidden'); inputEl.classList.remove('border-red-500', 'text-red-500'); 
        if (jenis === 'Keluar' || jenis === 'Transfer') { 
            if (sumberEl.value && sumberEl.value !== 'Loading...') { 
                try { 
                    const data = JSON.parse(sumberEl.value); const saldo = parseFloat(data.balance) || 0; 
                    if (nominal > saldo) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); errEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${translations[currentLang]['err_balance']} Sisa: ${formatRupiah(saldo)}`; errEl.classList.remove('hidden'); inputEl.classList.add('border-red-500', 'text-red-500'); } 
                } catch (e) { } 
            } 
        } 
    }

    function handleLogin(e) { e.preventDefault(); const u = document.getElementById('username').value; const p = document.getElementById('password').value; showLoader('loading'); google.script.run.withSuccessHandler(res => { hideLoader(); if(res.success) { currentUser = u; document.getElementById('section-login').classList.add('hidden'); nav('dashboard'); startAutoRefresh(); Swal.fire({ icon:'success', title:'Login Success', showConfirmButton:false, timer:1000, toast:true, position:'top-end' }); } else { Swal.fire({ icon:'error', title:'User / Password Incorrect', text:res.message }); } }).doLogin(u, p); }
    function logout() { Swal.fire({ title: translations[currentLang]['nav_logout']+'?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#6366f1', cancelButtonColor: '#d33', confirmButtonText: 'Yes' }).then((result) => { if (result.isConfirmed) { showLoader('loading'); if(autoRefreshInterval) clearInterval(autoRefreshInterval); setTimeout(() => { document.getElementById('username').value = ''; document.getElementById('password').value = ''; currentUser = ''; currentMasterType = 'bank'; document.getElementById('section-login').classList.remove('hidden'); if (document.body.classList.contains('mobile-sidebar-open')) { toggleSidebar(); } nav('dashboard'); hideLoader(); }, 500); } }); }
    function submitChangePassword(e) { e.preventDefault(); const oldP = document.getElementById('old-pass').value; const newP = document.getElementById('new-pass').value; const confP = document.getElementById('confirm-pass').value; if(newP !== confP) { Swal.fire('Error','Konfirmasi password tidak cocok!','error'); return; } showLoader('loading'); google.script.run.withSuccessHandler(res => { hideLoader(); if(res.success) { Swal.fire('Sukses', 'Password berhasil diubah!', 'success'); document.getElementById('old-pass').value = ''; document.getElementById('new-pass').value = ''; document.getElementById('confirm-pass').value = ''; } else { Swal.fire('Gagal', res.message, 'error'); } }).changeUserPassword(currentUser, oldP, newP); }
    
    function startAutoRefresh() {
        if(autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(() => {
            const viewDashboard = document.getElementById('view-dashboard');
            if (!viewDashboard.classList.contains('hidden') && document.getElementById('modal-form').classList.contains('hidden') && document.getElementById('modal-payment').classList.contains('hidden')) {
                google.script.run.withSuccessHandler(res => {
                    if (localDataTimestamp === '0') { localDataTimestamp = res.serverTimestamp; } 
                    else if (res.hasUpdate) {
                        localDataTimestamp = res.serverTimestamp;
                        google.script.run.withSuccessHandler(d => {
                            animateValue(document.getElementById('val-card1'), 0, d.card1, 1500); animateValue(document.getElementById('val-card2'), 0, d.card2, 1500); animateValue(document.getElementById('val-card3'), 0, d.card3, 1500); animateValue(document.getElementById('val-card4'), 0, d.card4, 1500);
                            renderDashboardCharts(d.chart); renderRecentTable(d.recents);
                        }).getDashboardData();
                        google.script.run.withSuccessHandler(renderLineChart).getChartHistory();
                    }
                }).checkDataUpdate(localDataTimestamp);
            }
        }, 20000);
    }

    function animateValue(obj, start, end, duration) { let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); const easeProgress = 1 - Math.pow(1 - progress, 3); const current = Math.floor(easeProgress * (end - start) + start); obj.innerText = formatRupiah(current); if (progress < 1) { window.requestAnimationFrame(step); } else { obj.innerText = formatRupiah(end); } }; window.requestAnimationFrame(step); }
    function loadDashboard() { showLoader('loading'); google.script.run.withSuccessHandler(d => { hideLoader(); animateValue(document.getElementById('val-card1'), 0, d.card1, 1500); animateValue(document.getElementById('val-card2'), 0, d.card2, 1500); animateValue(document.getElementById('val-card3'), 0, d.card3, 1500); animateValue(document.getElementById('val-card4'), 0, d.card4, 1500); renderDashboardCharts(d.chart); renderRecentTable(d.recents); }).getDashboardData(); google.script.run.withSuccessHandler(renderLineChart).getChartHistory(); }
    function renderDashboardCharts(chartData) { const ctx = document.getElementById('chartDashboardDonut').getContext('2d'); if(window.myPieChart) window.myPieChart.destroy(); const isDark = document.documentElement.classList.contains('dark'); window.myPieChart = new Chart(ctx, { type:'doughnut', data:{labels:['Masuk', 'Keluar'], datasets:[{data:[chartData.in, chartData.out], backgroundColor:['#10b981','#ef4444'], borderWidth:0, hoverOffset: 20}]}, options:{ maintainAspectRatio:false, cutout:'35%', animation:{animateScale:true}, plugins:{ legend:{position:'bottom', labels:{usePointStyle:true, padding:20, color: isDark?'#cbd5e1':'#334155', font:{family:'Montserrat'}}} } } }); }
    
    function renderRecentTable(list) { 
        const tb = document.getElementById('dashboard-recent-table'); tb.innerHTML = ''; 
        if(!list || list.length === 0) { tb.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-slate-400">${translations[currentLang]['table_empty']}</td></tr>`; return; } 
        list.forEach((r, i) => { 
            let badge='bg-slate-100 text-slate-600', col='text-slate-700 dark:text-slate-300'; 
            if(r.kode === 'PEMASUKAN') { badge='bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400'; col='text-emerald-600 dark:text-emerald-400 font-bold'; } 
            else if(r.kode === 'PENGELUARAN') { badge='bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'; col='text-red-600 dark:text-red-400 font-bold'; } 
            else { badge='bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400'; col='text-blue-600 dark:text-blue-400 font-bold'; } 
            tb.innerHTML += `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition fade-up" style="animation-delay: ${i*0.05}s"><td class="p-4 whitespace-nowrap font-medium text-base">${r.tgl}</td><td class="p-4"><span class="${badge} px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase">${r.kode}</span></td><td class="p-4 font-medium text-base truncate max-w-[120px]">${r.kategori}</td><td class="p-4 text-sm uppercase text-slate-500 dark:text-slate-400 truncate max-w-[150px]">${r.ket}</td><td class="p-4 text-end text-base ${col} nominal-card-value" dir="ltr">${formatRupiah(r.nominal)}</td></tr>`; 
        }); 
    }
    
    function renderLineChart(data) { 
        if (!data || !data.income || !data.expense) return; 
        const ctx = document.getElementById('chartLine').getContext('2d'); if(window.myLineChart) window.myLineChart.destroy(); 
        const isDark = document.documentElement.classList.contains('dark'); const cT = isDark ? '#94a3b8' : '#64748b'; const cG = isDark ? '#334155' : '#f1f5f9'; 
        window.myLineChart = new Chart(ctx, { type: 'line', data: { labels: data.labels, datasets: [ { label: 'Masuk', data: data.income, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4, fill: true, pointRadius:0, pointHoverRadius:8 }, { label: 'Keluar', data: data.expense, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.4, fill: true, pointRadius:0, pointHoverRadius:8 } ] }, options: { maintainAspectRatio: false, interaction:{mode:'index',intersect:false}, plugins: { legend: { labels: { color: cT, font: {family:'Montserrat'}, usePointStyle: true } } }, scales: { x: { grid: { display:false }, ticks: { color: cT } }, y: { grid: { color: cG, borderDash:[5,5] }, ticks: { color: cT } } } } }); 
    }
    
    function resetReportFilter() {
        document.getElementById('filter-start').value = ''; document.getElementById('filter-end').value = ''; document.getElementById('filter-category').value = '';
        reportDataRaw = []; reportPage = 1; document.getElementById('report-total-badge').innerText = `0 Data`;
        renderReportSlice(); 
        if (window.myReportLine) { window.myReportLine.destroy(); window.myReportLine = null; }
        if (window.myReportPie) { window.myReportPie.destroy(); window.myReportPie = null; }
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, timerProgressBar: true });
        Toast.fire({icon: 'success', title: 'Cleared'});
    }

    function loadReport(){
        const start = document.getElementById('filter-start').value; const end = document.getElementById('filter-end').value; const cat = document.getElementById('filter-category').value;
        if (!start || !end) { Swal.fire({ icon: 'warning', title: 'Warning', text: 'Select Date!', confirmButtonColor: '#6366f1' }); return; }
        showLoader('loading_data');
        google.script.run.withSuccessHandler(d=>{ 
            hideLoader(); reportDataRaw=d; reportPage=1; document.getElementById('report-total-badge').innerText=`${d.length} Data`; renderReportSlice(); 
        }).getTransactionData(start, end, cat);
        google.script.run.withSuccessHandler(renderReportCharts).getReportChartData(start, end, cat);
    }
    
    function renderReportSlice(){ 
        const tb=document.getElementById('report-body'); tb.innerHTML=''; 
        if(!reportDataRaw.length){tb.innerHTML=`<tr><td colspan="6" class="p-4 text-center text-slate-400">${translations[currentLang]['table_empty']}</td></tr>`;return;} 
        const start=(reportPage-1)*reportRowsPerPage, end=start+reportRowsPerPage, sliced=reportDataRaw.slice(start,end); 
        document.getElementById('report-page-info').innerText=`${translations[currentLang]['show']} ${start+1}-${Math.min(end,reportDataRaw.length)} of ${reportDataRaw.length}`; 
        document.getElementById('btn-report-prev').disabled=reportPage===1; document.getElementById('btn-report-next').disabled=end>=reportDataRaw.length; 
        sliced.forEach((r,i)=>{ 
            let badge='bg-slate-100 text-slate-600', sign=''; if(r.kode==='PENGELUARAN'){badge='bg-red-100 text-red-600';sign='-';} if(r.kode==='PEMASUKAN'){badge='bg-green-100 text-green-600';sign='+';} if(r.kode==='TRANSFER')badge='bg-blue-100 text-blue-600'; 
            tb.innerHTML+=`<tr class="border-b border-slate-50 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition fade-up" style="animation-delay:${i*0.05}s"><td class="p-4 text-sm font-bold text-slate-400">${start+i+1}</td><td class="p-4 whitespace-nowrap font-medium text-base">${r.tanggal}</td><td class="p-4"><span class="${badge} px-2 py-1 rounded text-sm font-bold">${r.kode}</span></td><td class="p-4 font-medium text-base">${r.kategori}</td><td class="p-4 text-sm uppercase text-slate-500 dark:text-slate-400">${r.keterangan}</td><td class="p-4 text-end font-bold text-base ${r.nominal<0?'text-red-500 dark:text-red-400':'text-emerald-600 dark:text-emerald-400'} nominal-card-value" dir="ltr">${formatRupiah(r.nominal)}</td></tr>`; 
        }); 
    }
    
    function renderReportCharts(data) {
        if (!data || !data.line || !data.pie) return;
        const isDark = document.documentElement.classList.contains('dark'); const cT = isDark ? '#94a3b8' : '#64748b'; const cG = isDark ? '#334155' : '#f1f5f9';
        const ctxLine = document.getElementById('chartReportLine');
        if (ctxLine) {
            if (window.myReportLine) window.myReportLine.destroy();
            window.myReportLine = new Chart(ctxLine.getContext('2d'), { type: 'line', data: { labels: data.line.labels, datasets: [ { label: 'In', data: data.line.income, borderColor: '#10b981', tension: 0.3, pointRadius: 3, fill: false }, { label: 'Out', data: data.line.expense, borderColor: '#ef4444', tension: 0.3, pointRadius: 3, fill: false } ] }, options: { maintainAspectRatio: false, plugins: { legend: { labels: { color: cT, font: { family: 'Montserrat' }, usePointStyle: true } } }, scales: { x: { ticks: { color: cT }, grid: { display: false } }, y: { ticks: { color: cT }, grid: { color: cG, borderDash: [5, 5] } } } } });
        }
        const ctxPie = document.getElementById('chartReportPie');
        if (ctxPie) {
            if (window.myReportPie) window.myReportPie.destroy();
            window.myReportPie = new Chart(ctxPie.getContext('2d'), { type: 'doughnut', data: { labels: data.pie.labels, datasets: [{ data: data.pie.data, backgroundColor: ['#f87171', '#fb923c', '#facc15', '#a3e635', '#4ade80', '#22d3ee', '#818cf8', '#a78bfa', '#e879f9'], borderWidth: 0, hoverOffset: 20 }] }, options: { maintainAspectRatio: false, cutout: '35%', animation: { animateScale: true }, plugins: { legend: { position: 'bottom', labels: { color: cT, font: { family: 'Montserrat', size: 11, weight: '600' }, usePointStyle: true, padding: 20 } } } } });
        }
    }

    function switchMaster(t) { 
        currentMasterType=t; document.getElementById('master-type-select').value = t; let fetchType = t === 'piutang' ? 'hutang' : t; 
        document.getElementById('investasi-summary-container').innerHTML = ''; document.getElementById('investasi-summary-container').classList.add('hidden');
        showLoader('loading'); 
        google.script.run.withSuccessHandler(d => { 
            hideLoader(); 
            if (t === 'hutang') d = d.filter(x => x.kategori === 'HUTANG');
            if (t === 'piutang') d = d.filter(x => x.kategori === 'PIUTANG');
            if (t === 'investasi') { document.getElementById('master-summary-card').classList.add('hidden'); renderInvestmentSummary(d); } 
            else { document.getElementById('master-summary-card').classList.remove('hidden'); updateMasterSummaryCard(d); }
            renderMasterTable(d); 
        }).getMasterData(fetchType); 
    }

    function renderInvestmentSummary(data) {
        const container = document.getElementById('investasi-summary-container'); container.classList.remove('hidden');
        const summary = {}; let grandTotal = 0;
        data.forEach(item => { const kat = item.kategori.toUpperCase(); const val = parseFloat(item.saldo) || 0; if (!summary[kat]) summary[kat] = 0; summary[kat] += val; grandTotal += val; });
        let html = `<div class="bg-gradient-to-br from-indigo-600 to-blue-600 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden bounce-card border border-white/10"><div class="relative z-10"><p class="text-[10px] font-bold opacity-80 uppercase tracking-widest mb-1">TOTAL</p><h3 class="text-xl font-bold tracking-tight nominal-card-value text-start" dir="ltr">${formatRupiah(grandTotal)}</h3></div><div class="absolute end-2 bottom-2 p-2 bg-white/20 rounded-xl backdrop-blur-sm"><i class="fa-solid fa-vault text-lg"></i></div></div>`;
        const colors = ['from-emerald-500 to-teal-500', 'from-amber-500 to-orange-500', 'from-pink-500 to-rose-500', 'from-purple-500 to-violet-500', 'from-cyan-500 to-blue-500'];
        Object.keys(summary).forEach((key, index) => {
            const colorClass = colors[index % colors.length];
            html += `<div class="bg-gradient-to-br ${colorClass} rounded-2xl p-5 text-white shadow-lg relative overflow-hidden bounce-card border border-white/10"><div class="relative z-10"><p class="text-[10px] font-bold opacity-80 uppercase tracking-widest mb-1">${key}</p><h3 class="text-xl font-bold tracking-tight nominal-card-value text-start" dir="ltr">${formatRupiah(summary[key])}</h3></div><div class="absolute end-2 bottom-2 p-2 bg-white/20 rounded-xl backdrop-blur-sm"><i class="fa-solid fa-chart-pie text-lg"></i></div></div>`;
        });
        container.innerHTML = html;
    }

    function renderMasterTable(d){ tableDataRaw=d; tableDataFiltered=d; currentPage=1; document.getElementById('table-search').value=''; if(currentMasterType !== 'investasi') updateMasterSummaryCard(d); renderTableSlice(); }
    function updateMasterSummaryCard(data) { let total = 0; let label = 'TOTAL ' + currentMasterType.toUpperCase(); let iconClass = 'fa-building-columns'; let colorClass = 'from-blue-500 to-blue-600'; if (currentMasterType === 'bank') { total = data.reduce((sum, item) => sum + (parseFloat(item.saldo)||0), 0); colorClass = 'from-blue-500 to-blue-600'; iconClass = 'fa-building-columns'; } else if (currentMasterType === 'ewallet') { total = data.reduce((sum, item) => sum + (parseFloat(item.saldo)||0), 0); colorClass = 'from-purple-500 to-purple-600'; iconClass = 'fa-mobile-screen'; } else if (currentMasterType === 'tunai') { total = data.reduce((sum, item) => sum + (parseFloat(item.saldo)||0), 0); colorClass = 'from-emerald-500 to-emerald-600'; iconClass = 'fa-money-bill-wave'; } else if (currentMasterType === 'investasi') { total = data.reduce((sum, item) => sum + (parseFloat(item.saldo)||0), 0); colorClass = 'from-amber-500 to-amber-600'; iconClass = 'fa-gem'; } else if (currentMasterType === 'tabungan') { total = data.reduce((sum, item) => sum + (parseFloat(item.saldo)||0), 0); label = 'TOTAL TABUNGAN'; colorClass = 'from-pink-500 to-rose-500'; iconClass = 'fa-piggy-bank'; } else if (currentMasterType === 'hutang') { total = data.reduce((sum, item) => sum + (parseFloat(item.saldo_akhir)||0), 0); label = 'SISA HUTANG'; colorClass = 'from-red-500 to-red-600'; iconClass = 'fa-file-invoice-dollar'; } else if (currentMasterType === 'piutang') { total = data.reduce((sum, item) => sum + (parseFloat(item.saldo_akhir)||0), 0); label = 'SISA PIUTANG'; colorClass = 'from-emerald-600 to-teal-500'; iconClass = 'fa-hand-holding-dollar'; } else if (currentMasterType === 'rencana') { total = data.reduce((sum, item) => sum + (parseFloat(item.saldo)||0), 0); label = 'TOTAL BUDGET RENCANA'; colorClass = 'from-cyan-500 to-cyan-600'; iconClass = 'fa-list-check'; } const card = document.getElementById('master-summary-card'); card.className = `rounded-3xl p-6 text-white shadow-lg mb-6 relative overflow-hidden transition-all duration-500 bg-gradient-to-r ${colorClass}`; document.getElementById('master-total-label').innerText = label; document.getElementById('master-total-icon').className = `fa-solid ${iconClass} text-3xl`; document.getElementById('master-total-count').innerText = `${data.length} Data`; animateValue(document.getElementById('master-total-value'), 0, total, 1000); }
    function handleSearch(k){ tableDataFiltered=tableDataRaw.filter(i=>Object.values(i).join(' ').toLowerCase().includes(k.toLowerCase())); currentPage=1; renderTableSlice(); }
    function changeLimit(v){ rowsPerPage=parseInt(v); currentPage=1; renderTableSlice(); }
    function changePage(d){ const m=Math.ceil(tableDataFiltered.length/rowsPerPage); const n=currentPage+d; if(n>0&&n<=m){currentPage=n;renderTableSlice();} }
    
    function renderTableSlice() { 
        const tb=document.getElementById('table-body-master'), th=document.getElementById('table-head-row'); 
        let h=['No']; 
        if(currentMasterType==='hutang'||currentMasterType==='piutang') h.push(...['Jenis','Nama','Sumber','Awal','Sisa','Status']); 
        else if(currentMasterType==='investasi') h.push(...['Nama','Kategori','Nilai','Tgl']); 
        else if(currentMasterType==='rencana') h.push(...['Nama','Tipe','Budget','Tgl']); 
        else if(currentMasterType==='tabungan') h.push(...['Saldo','Keterangan','Update']); 
        else h.push(...['Nama Akun','Saldo','Update']); h.push('Aksi'); 
        th.innerHTML = h.map(x=>`<th class="px-4 py-3 whitespace-nowrap text-start">${x}</th>`).join(''); 
        
        const start=(currentPage-1)*rowsPerPage, end=start+rowsPerPage, sliced=tableDataFiltered.slice(start,end); 
        document.getElementById('page-info').innerText = sliced.length===0? translations[currentLang]['table_no_data'] :`${translations[currentLang]['show']} ${start+1}-${Math.min(end,tableDataFiltered.length)} of ${tableDataFiltered.length}`; 
        document.getElementById('btn-prev').disabled=currentPage===1; document.getElementById('btn-next').disabled=end>=tableDataFiltered.length; 
        tb.innerHTML=''; 
        if(!sliced.length){tb.innerHTML=`<tr><td colspan="${h.length}" class="p-6 text-center text-slate-400">${translations[currentLang]['table_empty']}</td></tr>`;return;} 
        
        sliced.forEach((i,idx)=>{ 
            let tds=`<td class="px-4 py-3 font-bold text-slate-400 text-sm">${start+idx+1}</td>`; 
            let statusDisplay = i.status; 
            if(currentMasterType==='hutang'||currentMasterType==='piutang'){ 
                statusDisplay = (i.status === 'Lunas') ? `<span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs font-bold">LUNAS</span>` : `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">BELUM LUNAS</span>`; 
            }
            if(currentMasterType==='hutang'||currentMasterType==='piutang') tds+=`<td class="px-4 py-3">${i.kategori}</td><td class="px-4 py-3 whitespace-nowrap font-medium">${i.keterangan}</td><td class="px-4 py-3">${i.sumber}</td><td class="px-4 py-3 nominal-card-value text-start" dir="ltr">${formatRupiah(i.saldo_awal)}</td><td class="px-4 py-3 font-bold nominal-card-value text-start" dir="ltr">${formatRupiah(i.saldo_akhir)}</td><td class="px-4 py-3">${statusDisplay}</td>`; 
            else if(currentMasterType==='investasi') tds+=`<td class="px-4 py-3 font-bold">${i.nama}</td><td class="px-4 py-3">${i.kategori}</td><td class="px-4 py-3 text-emerald-600 font-bold nominal-card-value text-start" dir="ltr">${formatRupiah(i.saldo)}</td><td class="px-4 py-3">${i.tanggal}</td>`; 
            else if(currentMasterType==='rencana') tds+=`<td class="px-4 py-3 font-bold">${i.nama}</td><td class="px-4 py-3">${i.kategori}</td><td class="px-4 py-3 font-bold nominal-card-value text-start" dir="ltr">${formatRupiah(i.saldo)}</td><td class="px-4 py-3">${i.tanggal}</td>`; 
            else if(currentMasterType==='tabungan') tds+=`<td class="px-4 py-3 font-bold text-pink-600 nominal-card-value text-start" dir="ltr">${formatRupiah(i.saldo)}</td><td class="px-4 py-3">${i.nama}</td><td class="px-4 py-3 text-sm text-slate-400">${i.tanggal}</td>`; 
            else tds+=`<td class="px-4 py-3 font-bold">${i.nama}</td><td class="px-4 py-3 font-bold text-emerald-600 nominal-card-value text-start" dir="ltr">${formatRupiah(i.saldo)}</td><td class="px-4 py-3 text-sm text-slate-400">${i.tanggal}</td>`; 
                
            const j=JSON.stringify(i).replace(/"/g,'"'); 
            let btns = ''; 
            if(currentMasterType==='hutang'||currentMasterType==='piutang') { 
                const btnLabel = currentMasterType==='hutang' ? translations[currentLang]['lbl_pay'] : translations[currentLang]['lbl_receive']; 
                const btnColor = currentMasterType==='hutang' ? 'text-emerald-500' : 'text-blue-500'; 
                if(i.status !== 'Lunas') { btns += `<button onclick="openPaymentModal(${j})" class="${btnColor} hover:text-emerald-700 p-2 transform hover:scale-110 font-bold text-xs uppercase" title="${btnLabel}"><i class="fa-solid fa-money-bill-wave"></i> ${btnLabel}</button>`; } 
                btns += `<button onclick="deleteData('${i.id}')" class="text-red-400 hover:text-red-600 p-2 transform hover:scale-110"><i class="fa-solid fa-trash"></i></button>`; 
            } else { 
                btns += `<button onclick="openModal(${j})" class="text-blue-500 hover:text-blue-700 p-2 transform hover:scale-110"><i class="fa-solid fa-pen"></i></button><button onclick="deleteData('${i.id}')" class="text-red-400 hover:text-red-600 p-2 transform hover:scale-110"><i class="fa-solid fa-trash"></i></button>`; 
            } 
            tb.innerHTML+=`<tr class="border-b border-slate-50 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition fade-up" style="animation-delay:${idx*0.05}s">${tds}<td class="px-4 py-3 whitespace-nowrap flex gap-2">${btns}</td></tr>`; 
        }); 
    }

    function openModal(d=null){
      document.getElementById('modal-form').classList.remove('hidden'); document.getElementById('f_id').value = d ? d.id : ''; 
      const c = document.getElementById('form-fields'); c.innerHTML = '';
      const inp = (l, n, v, ph) => `<div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">${l}</label><input type="text" placeholder="Isi Judul" name="${n}" value="${v||''}" placeholder="${ph||''}" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-xl outline-none text-sm uppercase-input focus:ring-2 focus:ring-primary placeholder-slate-300 dark:placeholder-slate-600 transition-all text-start" dir="ltr" required></div>`;
      const num = (l, n, v, ph) => `<div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">${l}</label><div class="relative"><input type="text" name="${n}" value="${v?new Intl.NumberFormat('id-ID').format(v):''}" placeholder="${ph||'0'}" onkeyup="formatCurrency(this)" class="w-full p-3 ps-12 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-xl outline-none text-sm font-bold focus:ring-2 focus:ring-primary placeholder-slate-300 dark:placeholder-slate-600 transition-all text-start" dir="ltr" required><span class="absolute start-4 top-3 text-slate-400 font-bold text-sm">Rp</span></div></div>`;

      if(currentMasterType === 'investasi'){ c.innerHTML += inp('Name', 'f_nama', d?.nama, '') + inp('Category', 'f_kategori', d?.kategori, '') + num('Amount', 'f_saldo', d?.saldo, '') + `<div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Date</label><input type="date" name="f_tanggal" value="${d?.raw_date||''}" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-xl outline-none text-sm focus:ring-2 focus:ring-primary text-start" dir="ltr"></div>`; }
      else if(currentMasterType === 'hutang' || currentMasterType === 'piutang'){ const katVal = currentMasterType === 'hutang' ? 'HUTANG' : 'PIUTANG'; c.innerHTML += `<input type="hidden" name="f_kategori" value="${katVal}"><input type="hidden" name="f_sumber" value='{"type":"dummy","id":"0","name":"-"}' ><input type="hidden" name="f_status" value="Belum Lunas">` + inp('Name', 'f_keterangan', d?.keterangan, '') + num('Amount', 'f_saldo', d?.saldo_awal, ''); }
      else if(currentMasterType === 'rencana'){ const k = d?.kategori || 'BUDGET'; c.innerHTML += inp('Name', 'f_nama', d?.nama, '') + `<div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Type</label><select name="f_kategori" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-xl outline-none text-sm focus:ring-2 focus:ring-primary"><option value="BUDGET" ${k==='BUDGET'?'selected':''}>Budget (Sekali Pakai)</option><option value="RUTIN" ${k==='RUTIN'?'selected':''}>Rutin (Bulanan)</option></select></div>` + num('Budget Amount', 'f_saldo', d?.saldo, '') + `<div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Target Date</label><input type="date" name="f_tanggal" value="${d?.raw_date||''}" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-xl outline-none text-sm focus:ring-2 focus:ring-primary text-start" dir="ltr"></div>`; }
      else if(currentMasterType === 'tabungan'){ c.innerHTML += num('Amount', 'f_saldo', d?.saldo, '') + inp('Description', 'f_nama', d?.nama, ''); }
      else { c.innerHTML += inp('Account Name', 'f_nama', d?.nama, '') + num('Balance', 'f_saldo', d?.saldo, ''); }
    }
    
    function openPaymentModal(d) {
        document.getElementById('modal-payment').classList.remove('hidden'); document.getElementById('p_id').value = d.id; document.getElementById('p_nama').value = d.keterangan; document.getElementById('p_sisa').value = formatRupiah(d.saldo_akhir);
        const pNominal = document.getElementById('p_nominal'); pNominal.value = ''; pNominal.dataset.max = d.saldo_akhir; pNominal.classList.remove('border-red-500', 'text-red-500');
        document.getElementById('error-overpay').classList.add('hidden'); document.getElementById('error-saldo-pay').classList.add('hidden'); document.getElementById('btn-pay').disabled = false; document.getElementById('btn-pay').classList.remove('opacity-50', 'cursor-not-allowed');
        const s = document.getElementById('p_sumber'); s.innerHTML = '<option>Loading...</option>';
        google.script.run.withSuccessHandler(acc => { s.innerHTML = '<option value="">-- Select --</option>' + buildOpts(acc.filter(a => ['bank','ewallet','tunai'].includes(a.type))); }).getAccountSources();
    }
    function closePaymentModal() { document.getElementById('modal-payment').classList.add('hidden'); }
    function submitPayment(e) { e.preventDefault(); Swal.fire({ title:'Process?', icon:'question', showCancelButton:true, confirmButtonText:'Yes' }).then((result) => { if (result.isConfirmed) { showLoader('loading'); const fd={}; new FormData(document.getElementById('payment-form')).forEach((v,k)=>fd[k]=v); google.script.run.withSuccessHandler(r => { hideLoader(); closePaymentModal(); switchMaster(currentMasterType); loadDashboard(); Swal.fire('Success', '', 'success'); }).processDebtPayment(fd); } }); }
    function exportToExcel() { if (!reportDataRaw || reportDataRaw.length === 0) { Swal.fire('Empty', '', 'warning'); return; } showLoader('loading'); google.script.run.withSuccessHandler(masterData => { hideLoader(); var wb = XLSX.utils.book_new(); var wsTrx = XLSX.utils.json_to_sheet(reportDataRaw); XLSX.utils.book_append_sheet(wb, wsTrx, "Transaksi"); if(masterData.bank.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(masterData.bank), "Bank"); if(masterData.investasi.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(masterData.investasi), "Aset"); if(masterData.rencana.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(masterData.rencana), "Rencana"); if(masterData.hutang.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(masterData.hutang), "Utang"); if(masterData.ewallet.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(masterData.ewallet), "Ewallet"); if(masterData.tunai.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(masterData.tunai), "Tunai"); XLSX.writeFile(wb, "Laporan_Keuangan_DompetKu.xlsx"); }).getAllMasterDataForExport(); }
    function closeModal(){document.getElementById('modal-form').classList.add('hidden')}
    function saveMaster(e){e.preventDefault(); Swal.fire({ title:'Save?', icon:'question', showCancelButton:true, confirmButtonText:'Yes' }).then((result) => { if (result.isConfirmed) { showLoader('loading'); const fd={}; new FormData(document.getElementById('master-form')).forEach((v,k)=>fd[k]=v); google.script.run.withSuccessHandler(()=>{ hideLoader(); closeModal(); switchMaster(currentMasterType); loadDashboard(); Swal.fire('Success', '', 'success'); }).saveMasterData(currentMasterType === 'piutang' ? 'hutang' : currentMasterType, fd); } }); }
    function deleteData(id){ Swal.fire({ title:'Delete?', icon:'warning', showCancelButton:true, confirmButtonText:'Yes' }).then((result) => { if (result.isConfirmed) { showLoader('loading'); google.script.run.withSuccessHandler(()=>{ hideLoader(); switchMaster(currentMasterType); Swal.fire('Deleted!', '', 'success'); }).deleteMasterData(currentMasterType === 'piutang' ? 'hutang' : currentMasterType, id); } }); }
    function changeReportLimit(v){reportRowsPerPage=parseInt(v);reportPage=1;renderReportSlice();}
    function changeReportPage(d){const m=Math.ceil(reportDataRaw.length/reportRowsPerPage); const n=reportPage+d; if(n>0&&n<=m){reportPage=n;renderReportSlice();}}
    function loadCategories(){google.script.run.withSuccessHandler(c=>{const s=document.getElementById('filter-category');s.innerHTML='<option value="">All</option>';c.forEach(x=>s.innerHTML+=`<option value="${x}">${x}</option>`) }).getCategories();}
    function loadAccountSources() { const s=document.getElementById('t_sumber'), t=document.getElementById('t_tujuan'); if(s)s.innerHTML='<option>Loading...</option>'; if(t)t.innerHTML='<option>Loading...</option>'; google.script.run.withSuccessHandler(acc => { if(s)s.innerHTML='<option value="">-- Select --</option>'+buildOpts(acc.filter(a=>['bank','ewallet','tunai'].includes(a.type))); if(t)t.innerHTML='<option value="">-- Select --</option>'+buildOpts(acc.filter(a=>['bank','ewallet','tunai','investasi','tabungan'].includes(a.type))); }).getAccountSources(); }
    function buildOpts(l){ const g={'bank':[],'ewallet':[],'tunai':[],'investasi':[],'tabungan':[]}; l.forEach(a=>{if(g[a.type])g[a.type].push(a)}); let h=''; for(const[t,i] of Object.entries(g)){if(i.length){h+=`<optgroup label="${t.toUpperCase()}">`;i.forEach(a=>{h+=`<option value='${JSON.stringify({type:a.type,id:a.id,name:a.name,balance:a.balance})}'>${a.name} (${formatRupiah(a.balance)})</option>`});h+='</optgroup>'}}return h;}
    
    function setJenis(t) { 
        document.getElementById('t_jenis').value = t; 
        const btns = {Masuk:document.getElementById('btn-masuk'), Keluar:document.getElementById('btn-keluar'), Transfer:document.getElementById('btn-transfer')}; 
        Object.values(btns).forEach(b => { b.className="flex-1 py-3 rounded-lg font-bold text-sm text-slate-500 transition-all hover:bg-slate-200 dark:hover:bg-slate-700"; }); 
        const activeClass = t==='Masuk' ? "bg-emerald-100 text-emerald-700 shadow-sm" : (t==='Keluar' ? "bg-red-100 text-red-700 shadow-sm" : "bg-blue-100 text-blue-700 shadow-sm"); 
        btns[t].className = `flex-1 py-3 rounded-lg font-bold text-sm transition-all ${activeClass}`; 
        document.getElementById('div-tujuan').classList.toggle('hidden', t!=='Transfer'); document.getElementById('div-kategori').classList.toggle('hidden', t==='Transfer'); 
        document.getElementById('label-sumber').innerText = t==='Transfer' ? translations[currentLang]['from_account'] : (t==='Masuk' ? translations[currentLang]['to_account'] : translations[currentLang]['from_account']); 
        if(t!=='Transfer') { const sel=document.getElementsByName('t_kategori')[0]; sel.innerHTML=''; listKategori[t].forEach(k=>sel.innerHTML+=`<option value="${k}">${k}</option>`); monitorKategori(sel); } else { toggleKeteranganInput(false); }
        validateBalance(); 
    }
    function monitorKategori(el) { const v=el.value; if(v.includes('HUTANG')) loadDropdown('HUTANG'); else if(v.includes('PIUTANG')) loadDropdown('PIUTANG'); else if(v.includes('RENCANA')) loadDropdown('RENCANA'); else toggleKeteranganInput(false); }
    function toggleKeteranganInput(isD) { const t=document.getElementById('input-keterangan-text'), s=document.getElementById('input-keterangan-select'), m=document.getElementById('input-keterangan-manual'); if(isD){t.classList.add('hidden');t.removeAttribute('name');t.removeAttribute('required');s.classList.remove('hidden');s.setAttribute('name','t_keterangan');s.setAttribute('required','true');m.classList.remove('hidden');}else{s.classList.add('hidden');s.removeAttribute('name');s.removeAttribute('required');m.classList.add('hidden');m.value='';t.classList.remove('hidden');t.setAttribute('name','t_keterangan');t.setAttribute('required','true');t.value='';}document.getElementsByName('t_nominal')[0].value='';}
    function loadDropdown(type) { toggleKeteranganInput(true); const s=document.getElementById('input-keterangan-select'); s.innerHTML='<option>Loading...</option>'; const run=google.script.run.withSuccessHandler(l=>{s.innerHTML='<option value="">-- Select --</option>'; if(!l||!l.length){s.innerHTML='<option value="">Empty/Paid</option>';return;} l.forEach(i=>{ let info=type==='RENCANA'?(i.category==='RUTIN'?(i.date?` | Dte:${i.date.slice(5)}`:''):' | Bud'):' | Rem'; s.innerHTML+=`<option value="${i.name}" data-amount="${i.amount}">${i.name} (${formatRupiah(i.amount)}${info})</option>`})}); if(type==='RENCANA')run.getActivePlans(); else run.getActiveDebts(type); }
    document.getElementById('input-keterangan-select').addEventListener('change',function(){const a=this.options[this.selectedIndex].getAttribute('data-amount');if(a)document.getElementsByName('t_nominal')[0].value=new Intl.NumberFormat('id-ID').format(a)});
    document.getElementsByName('t_kategori')[0].addEventListener('change',function(){monitorKategori(this)});
    function submitTransaksi(e){e.preventDefault(); Swal.fire({ title: 'Save?', icon: 'question', showCancelButton: true, confirmButtonText: 'Yes' }).then((result) => { if (result.isConfirmed) { showLoader('loading'); const f=document.getElementById('form-transaksi'); const fd={}; new FormData(f).forEach((v,k)=>fd[k]=v); google.script.run.withSuccessHandler(r=>{ hideLoader(); if(r.success){ f.reset(); document.getElementById('t_tanggal').valueAsDate=new Date(); setJenis(document.getElementById('t_jenis').value); loadAccountSources(); toggleKeteranganInput(false); loadDashboard(); Swal.fire({icon:'success', title:'Success', showConfirmButton:false, timer: 1500}); } else { Swal.fire({icon:'error', title:'Failed', text:r.message}); } }).saveTransaction(fd); } }); }
  </script>
</body>
</html>